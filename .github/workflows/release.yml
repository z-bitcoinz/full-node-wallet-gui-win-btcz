name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  FORCE_COLOR: "1"
  PYTHON_VERSION: "3.12"
  NSIS_VERSION: "3.10"

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Build the unsigned installer on Windows
  # ──────────────────────────────────────────────
  build:
    runs-on: windows-latest
    name: Build Installer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from pyproject.toml
        id: version
        shell: pwsh
        run: |
          $content = Get-Content pyproject.toml -Raw
          if ($content -match 'version\s*=\s*"([^"]+)"') {
            $version = $Matches[1]
            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "Detected version: $version"
          } else {
            Write-Error "Could not extract version from pyproject.toml"
            exit 1
          }

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv env
          env\Scripts\python -m pip install --upgrade pip
          env\Scripts\pip install briefcase==0.3.24

      - name: Build app with Briefcase
        run: |
          env\Scripts\briefcase build

      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis --version=${{ env.NSIS_VERSION }} -y

      - name: Build NSIS installer
        shell: pwsh
        run: |
          $makensis = "C:\Program Files (x86)\NSIS\makensis.exe"
          if (!(Test-Path $makensis)) {
            Write-Error "makensis.exe not found at $makensis"
            exit 1
          }
          & $makensis btczwallet.nsi

      - name: Upload unsigned installer
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-installer
          path: build\*.exe
          if-no-files-found: error

    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      installer_name: BTCZWallet-${{ steps.version.outputs.VERSION }}-setup-x64.exe

  # ──────────────────────────────────────────────
  # Job 2: Create GitHub Release
  # ──────────────────────────────────────────────
  release:
    runs-on: ubuntu-latest
    needs: build
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: unsigned-installer
          path: release

      - name: Detect prerelease
        id: prerelease
        shell: bash
        run: |
          TAG="${{ github.ref_name }}"
          if [[ "$TAG" =~ (rc|beta|alpha|dev) ]]; then
            echo "IS_PRERELEASE=true" >> "$GITHUB_OUTPUT"
          else
            echo "IS_PRERELEASE=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: BTCZWallet v${{ needs.build.outputs.version }}
          prerelease: ${{ steps.prerelease.outputs.IS_PRERELEASE }}
          generate_release_notes: true
          body: |
            ## BTCZWallet v${{ needs.build.outputs.version }}

            > **Note:** This build is unsigned — Windows SmartScreen may prompt during install.
            > Click "More info" → "Run anyway" to proceed.

            ### Installation
            1. Download the `.exe` installer below
            2. Run the installer
            3. Follow the setup wizard
          files: release/*.exe
